import unittest
import torch
from configparser import ConfigParser

from src.input_data_generator import InputDataGenerator
from lib.wel_minimal.conll_benchmark import conll_documents

class TestInputDataGenerator(unittest.TestCase):

    def setUp(self):
        self.config = ConfigParser()
        self.config.read('config.ini')

        # Set up the test subject
        self.subject = InputDataGenerator(
                wikipedia_abstracts_file=self.config['DATA']['Wikipedia Abstracts'],
                tokenizer_pretrained_id=self.config['BERT']['Model ID']
            )

    def tearDown(self):
        # Get rid of test subject
        self.subject = None
        self.config = None

    def test_get_vectorized_data(self):
        doc = next(conll_documents(self.config['DATA']['Conll Annotated']))
        doc_entities = [{'Position': [0, 0], 'GroundTruth': 'B', 'Candidates': ['Q4053754', 'Q5413406', 'Q224475', 'Q5330551', 'Q458']}, {'Position': [2, 2], 'GroundTruth': 'Q183', 'Candidates': ['Q2990861', 'Q3071702', 'Q24088311', 'Q2355124', 'Q5669068', 'Q6552879', 'Q261583', 'Q336526', 'Q4895077', 'Q7174212', 'Q5807368', 'Q945511', 'Q4798810', 'Q298022', 'Q7736211', 'Q22097207', 'Q188', 'Q2699418', 'Q5364500', 'Q3708826', 'Q16729252', 'Q7922414', 'Q2734574', 'Q3735925', 'Q348514', 'Q7380995', 'Q7344737']}, {'Position': [6, 6], 'GroundTruth': 'Q145', 'Candidates': ['Q842438', 'Q1196012', 'Q1248800', 'Q849811']}, {'Position': [9, 10], 'GroundTruth': 'B', 'Candidates': ['Q54893024', 'Q2073954', 'Q26634508', 'Q7172840']}, {'Position': [11, 11], 'GroundTruth': 'Q240', 'Candidates': []}, {'Position': [14, 15], 'GroundTruth': 'Q8880', 'Candidates': ['Q8880']}, {'Position': [22, 22], 'GroundTruth': 'Q183', 'Candidates': ['Q2990861', 'Q3071702', 'Q24088311', 'Q2355124', 'Q5669068', 'Q6552879', 'Q261583', 'Q336526', 'Q4895077', 'Q7174212', 'Q5807368', 'Q945511', 'Q4798810', 'Q298022', 'Q7736211', 'Q22097207', 'Q188', 'Q2699418', 'Q5364500', 'Q3708826', 'Q16729252', 'Q7922414', 'Q2734574', 'Q3735925', 'Q348514', 'Q7380995', 'Q7344737']}, {'Position': [28, 28], 'GroundTruth': 'Q145', 'Candidates': ['Q842438', 'Q1196012', 'Q1248800', 'Q849811']}, {'Position': [43, 43], 'GroundTruth': 'Q183', 'Candidates': ['Q41304', 'Q183', 'Q7318', 'Q22006587', 'Q1350565', 'Q423030', 'Q16209935']}, {'Position': [48, 49], 'GroundTruth': 'Q458', 'Candidates': ['Q319328', 'Q458']}, {'Position': [53, 54], 'GroundTruth': 'B', 'Candidates': []}, {'Position': [66, 66], 'GroundTruth': 'Q145', 'Candidates': ['Q16054730', 'Q3240725', 'Q690213']}, {'Position': [94, 94], 'GroundTruth': 'Q8880', 'Candidates': ['Q409597']}, {'Position': [98, 101], 'GroundTruth': 'B', 'Candidates': []}, {'Position': [129, 130], 'GroundTruth': 'Q458', 'Candidates': ['Q319328', 'Q458']}, {'Position': [139, 139], 'GroundTruth': 'B', 'Candidates': ['Q4053754', 'Q5413406', 'Q224475', 'Q5330551', 'Q458']}, {'Position': [142, 143], 'GroundTruth': 'Q78587', 'Candidates': ['Q78587']}, {'Position': [172, 172], 'GroundTruth': 'B', 'Candidates': ['Q2381525', 'Q1420333', 'Q2169476', 'Q78587', 'Q17180596', 'Q534915', 'Q3496482', 'Q686638']}, {'Position': [174, 174], 'GroundTruth': 'B', 'Candidates': []}, {'Position': [179, 179], 'GroundTruth': 'Q145', 'Candidates': ['Q16054730', 'Q3240725', 'Q690213']}, {'Position': [181, 181], 'GroundTruth': 'Q142', 'Candidates': ['Q5548178', 'Q726049', 'Q3037933', 'Q2556465', 'Q659488', 'Q16211444', 'Q732921', 'Q207162', 'Q5362797', 'Q504906', 'Q16275867', 'Q2149490', 'Q3080562', 'Q929852', 'Q142', 'Q6557993', 'Q5342978', 'Q49644', 'Q70802', 'Q6557995', 'Q70972', 'Q1083398', 'Q5478259', 'Q1658604', 'Q30123054', 'Q6408628', 'Q5525090', 'Q294485', 'Q3209212', 'Q42443', 'Q17351934']}, {'Position': [189, 191], 'GroundTruth': 'B', 'Candidates': []}, {'Position': [193, 193], 'GroundTruth': 'Q154666', 'Candidates': ['Q7449138', 'Q2636119', 'Q154666', 'Q638398', 'Q2380000', 'Q851259', 'Q4858621', 'Q1972649', 'Q262909', 'Q2480956', 'Q4081230']}, {'Position': [201, 201], 'GroundTruth': 'B', 'Candidates': ['Q2381525', 'Q1420333', 'Q2169476', 'Q78587', 'Q17180596', 'Q534915', 'Q3496482', 'Q686638']}, {'Position': [209, 209], 'GroundTruth': 'B', 'Candidates': ['Q4053754', 'Q5413406', 'Q224475', 'Q5330551', 'Q458']}, {'Position': [237, 237], 'GroundTruth': 'Q29', 'Candidates': ['Q241649', 'Q6267714', 'Q7573131', 'Q1321', 'Q3492565']}, {'Position': [240, 242], 'GroundTruth': 'Q255657', 'Candidates': ['Q255657']}, {'Position': [246, 246], 'GroundTruth': 'B', 'Candidates': ['Q2381525', 'Q1420333', 'Q2169476', 'Q78587', 'Q17180596', 'Q534915', 'Q3496482', 'Q686638']}, {'Position': [249, 249], 'GroundTruth': 'B', 'Candidates': ['Q4053754', 'Q5413406', 'Q224475', 'Q5330551', 'Q458']}, {'Position': [266, 266], 'GroundTruth': 'Q142', 'Candidates': ['Q5548178', 'Q726049', 'Q3037933', 'Q2556465', 'Q659488', 'Q16211444', 'Q732921', 'Q207162', 'Q5362797', 'Q504906', 'Q16275867', 'Q2149490', 'Q3080562', 'Q929852', 'Q142', 'Q6557993', 'Q5342978', 'Q49644', 'Q70802', 'Q6557995', 'Q70972', 'Q1083398', 'Q5478259', 'Q1658604', 'Q30123054', 'Q6408628', 'Q5525090', 'Q294485', 'Q3209212', 'Q42443', 'Q17351934']}, {'Position': [268, 268], 'GroundTruth': 'Q145', 'Candidates': ['Q16054730', 'Q3240725', 'Q690213']}, {'Position': [270, 270], 'GroundTruth': 'B', 'Candidates': ['Q2381525', 'Q1420333', 'Q2169476', 'Q78587', 'Q17180596', 'Q534915', 'Q3496482', 'Q686638']}, {'Position': [275, 275], 'GroundTruth': 'B', 'Candidates': ['Q4053754', 'Q5413406', 'Q224475', 'Q5330551', 'Q458']}, {'Position': [314, 314], 'GroundTruth': 'Q154666', 'Candidates': ['Q7449138', 'Q2636119', 'Q154666', 'Q638398', 'Q2380000', 'Q851259', 'Q4858621', 'Q1972649', 'Q262909', 'Q2480956', 'Q4081230']}, {'Position': [330, 330], 'GroundTruth': 'Q145', 'Candidates': ['Q842438', 'Q1196012', 'Q1248800', 'Q849811']}, {'Position': [350, 350], 'GroundTruth': 'Q183', 'Candidates': ['Q2990861', 'Q3071702', 'Q24088311', 'Q2355124', 'Q5669068', 'Q6552879', 'Q261583', 'Q336526', 'Q4895077', 'Q7174212', 'Q5807368', 'Q945511', 'Q4798810', 'Q298022', 'Q7736211', 'Q22097207', 'Q188', 'Q2699418', 'Q5364500', 'Q3708826', 'Q16729252', 'Q7922414', 'Q2734574', 'Q3735925', 'Q348514', 'Q7380995', 'Q7344737']}, {'Position': [357, 357], 'GroundTruth': 'Q145', 'Candidates': ['Q842438', 'Q1196012', 'Q1248800', 'Q849811']}, {'Position': [363, 363], 'GroundTruth': 'Q46', 'Candidates': ['Q345567', 'Q5412139', 'Q5412140', 'Q46', 'Q5412143', 'Q7815733', 'Q185144', 'Q579160', 'Q3734794', 'Q17065610', 'Q766618', 'Q198697', 'Q20706779', 'Q47462515', 'Q612228', 'Q165170', 'Q458']}, {'Position': [382, 382], 'GroundTruth': 'Q183', 'Candidates': ['Q41304', 'Q183', 'Q7318', 'Q22006587', 'Q1350565', 'Q423030', 'Q16209935']}, {'Position': [387, 391], 'GroundTruth': 'B', 'Candidates': []}, {'Position': [393, 393], 'GroundTruth': 'B', 'Candidates': ['Q564246', 'Q6972569', 'Q6972571']}, {'Position': [396, 398], 'GroundTruth': 'B', 'Candidates': []}, {'Position': [401, 402], 'GroundTruth': 'B', 'Candidates': []}, {'Position': [404, 404], 'GroundTruth': 'Q586', 'Candidates': ['Q892680', 'Q586', 'Q24203375']}, {'Position': [420, 420], 'GroundTruth': 'Q145', 'Candidates': ['Q842438', 'Q1196012', 'Q1248800', 'Q849811']}, {'Position': [438, 438], 'GroundTruth': 'Q183', 'Candidates': ['Q41304', 'Q183', 'Q7318', 'Q22006587', 'Q1350565', 'Q423030', 'Q16209935']}, {'Position': [443, 443], 'GroundTruth': 'Q145', 'Candidates': ['Q16054730', 'Q3240725', 'Q690213']}, {'Position': [459, 459], 'GroundTruth': 'Q145', 'Candidates': ['Q842438', 'Q1196012', 'Q1248800', 'Q849811']}]
        result = next(self.subject.get_vectorized_data(doc, doc_entities))
        expected_input_ids = torch.ShortTensor([[  101,  2446,  7327, 19164,  2446,  2655,  2000, 17757,  2329, 12559,  1012,  2848, 13934,  9371,  2727,  1011,  5511,  1011,  2570,  1996,  2647,  3222,  2056,  2006,  9432,  2009, 18335,  2007,  2446,  6040,  2000, 10390,  2000, 18454,  2078,  2329, 12559,  2127,  6529,  5646,  3251,  5506, 11190,  4295,  2064,  2022, 11860,  2000,  8351,  1012,  2762,  1005,  1055,  4387,  2000,  1996,  2647,  2586,  1005,  1055, 15651,  2837, 14121,  1062,  9328,  5804,  2056,  2006,  9317, 10390,  2323,  4965,  8351,  4168,  4017,  2013,  3032,  2060,  2084,  3725,  2127,  1996,  4045,  6040,  2001, 24509,  1012,  1000,  2057,  2079,  1050,  1005,  1056,  2490,  2151,  2107, 12832,  2138,  2057,  2079,  1050,  1005,  1056,  2156,  2151,  5286,  2005,  2009,  1010,  1000,  1996,  3222,  1005,  1055,  2708, 14056, 24794,  2271,  3158,  4315, 14674,  2409,  1037,  2739, 27918,  1012,  2002,  2056,  2582,  4045,  2817,  2001,  3223,  1998,  2065,  2009,  2001,  2179,  2008,  2895,  2001,  2734,  2009,  2323,  2022,  2579,  2011,  1996,  2647,  2586,  1012,  2002,  2056,  1037,  6378,  2197,  3204,  2011,  7327,  3888,  5849,  8965, 27424,  2818,  3917,  2000,  7221,  8351, 14332,  1010, 11867, 24129,  2015,  1998, 16492, 24551,  2013,  1996,  2529,  1998,  4111,  2833,  8859,  2001,  1037,  3811,  3563,  1998,  3653,  3540, 13700,  5649,  2693,  2000,  4047,  2529,  2740,  1012, 27424,  2818,  3917,  3818,  7327,  1011,  2898,  5761,  2044,  4311,  2013,  3725,  1998,  2605,  2008,  2104,  5911,  3785,  8351,  2071,  3206,  8945, 20534, 11867,  5063, 22631,  4372,  3401, 21890,  4135, 20166,  1006, 18667,  2063,  1007,  1011,  1011,  5506, 11190,  4295,  1012,  2021, 27424,  2818,  3917,  3530,  2000,  3319,  2010,  6378,  2044,  1996,  7327,  1005,  1055,  3061, 15651,  2837,   102,  2446,  1010,  8063,  2446,  2003,  1037,  5101,  1999,  2430,  2530,  8063,  1010,  2112,  1997,  1996,  3007,  8755,  1012,  2009,  3658,  2012,  1996,  3329,  1997,  1996,  8840, 10431,  4020,  1010,  2012,  1010,  6191,  2683,  3620,  2682,  2712,  2504,  1012,  2004,  1997,  2289,  1010,  2009,  2038,  1037,  2313,  1997,  1016,  1010, 19975,  1998,  1996,  3664,  2003, 28681,  2953, 24728,  7724,  1012,  2446,  2003,  1996,  2609,  1997,  1996,  2446,  6408,  1997,  3002,  2198,  1997, 15544,  2721,  1010,  9382,  2631,  1999,  1996,  6049,  2301,  1998,  2059,  4704,  1998, 14858,  2195,  2335,  1012,  2009,  2838,  1037,  2277,  2013,  6571,  2007, 23360,  2013,  6929,  2011,  3520, 16366,  2615,  5972,  1012,  2144,  4662,  1010,  2009,  2003,  3200,  1997,  1996,  7643,  1062,  8649, 27528,  6408,  2006,  4057,  2012, 15006,  1012,  2127,  2238,  2294,  1010,  2446,  2018,  1037,  4659,  3144,  2374,  2136,  1010,  1052, 11329, 13171, 20011,  3630,  2446,  1010,  2040,  4719,  4712,  2000,  1996,  1037,  1052,  2546,  2290,  1010,  1996,  3284,  2407,  1997,  7643,  2374,  1012,  2588,  4712,  1010,  2174,  1010,  2027,  2904,  6095,  1010,  2187,  2446,  1998,  2020,  4096,  1052, 11329, 24188,  3630,  5974,  3215, 20934, 28921,  2015,  8755,  1012,  1996,  2171,  1997,  1996,  2237,  3310,  2013,  1000,  2446,  1000,  1997, 13838, 11327,  2030, 12626,  2446,  2271,  1045,  1997, 11776,  1010,  2025,  1996,  2406,  2030,  2111,  1997,  2762,  1012,  2023,  5101,  1997,  8755,  2003,  2025,  2000,  2022,  5457,  2007,  1996,  3760,  2352,  1997,  1040, 27922, 18689,  2379,  4241,  2361,  3490, 27110,  1999, 18712, 19966, 10497,  4014,  2874,  1012,  2446,  6000,  2006,  2991, 21253,  2015,  3023,  1999, 12615,  2003,  2315,  2044,  1996,   102]])
        expected_attention_mask = torch.BoolTensor(512*[True])
        expected_attention_mask = expected_attention_mask.unsqueeze(0)
        expected_token_type_ids = torch.BoolTensor(257*[False]+255*[True])
        expected_token_type_ids = expected_token_type_ids.unsqueeze(0)
        expected_label = False

        err_msg = "Error in {}"
        self.assertTrue(torch.equal(expected_input_ids, result[0]), err_msg.format("vector 'input_ids'"))
        self.assertTrue(torch.equal(expected_attention_mask, result[1]), err_msg.format("vector 'attention_mask'"))
        self.assertTrue(torch.equal(expected_token_type_ids, result[2]), err_msg.format("vector 'token_type_ids'"))
        self.assertEqual(expected_label, result[3], err_msg.format("label"))


if __name__ == '__main__':
    unittest.main()

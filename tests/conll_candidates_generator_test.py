import unittest
from configparser import ConfigParser
# import os
# import sys
# sys.path.append(os.getcwd())

from src.conll_candidates_generator import ConllCandidatesGenerator
from lib.wel_minimal.conll_benchmark import conll_documents

class TestConllCandidatesGenerator(unittest.TestCase):

    def setUp(self):
        self.config = ConfigParser()
        self.config.read('config.ini')

        # Set up the test subject
        self.subject = ConllCandidatesGenerator(
                spacy_nlp_vocab_dir=self.config['DATA']['Spacy Vocab Dir'],
                spacy_kb_file=self.config['DATA']['Spacy KB']
            )

    def tearDown(self):
        # Get rid of test subject
        self.subject = None
        self.config = None

    def test_generate_candidates_for_doc(self):
        doc = next(conll_documents(self.config['DATA']['Conll Annotated']))
        expected = [{'Position': [0, 0], 'GroundTruth': 'B', 'Candidates': ['Q4053754', 'Q5413406', 'Q224475', 'Q5330551', 'Q458']}, {'Position': [2, 2], 'GroundTruth': 'Q183', 'Candidates': ['Q2990861', 'Q3071702', 'Q24088311', 'Q2355124', 'Q5669068', 'Q6552879', 'Q261583', 'Q336526', 'Q4895077', 'Q7174212', 'Q5807368', 'Q945511', 'Q4798810', 'Q298022', 'Q7736211', 'Q22097207', 'Q188', 'Q2699418', 'Q5364500', 'Q3708826', 'Q16729252', 'Q7922414', 'Q2734574', 'Q3735925', 'Q348514', 'Q7380995', 'Q7344737']}, {'Position': [6, 6], 'GroundTruth': 'Q145', 'Candidates': ['Q842438', 'Q1196012', 'Q1248800', 'Q849811']}, {'Position': [9, 10], 'GroundTruth': 'B', 'Candidates': ['Q54893024', 'Q2073954', 'Q26634508', 'Q7172840']}, {'Position': [11, 11], 'GroundTruth': 'Q240', 'Candidates': []}, {'Position': [14, 15], 'GroundTruth': 'Q8880', 'Candidates': ['Q8880']}, {'Position': [22, 22], 'GroundTruth': 'Q183', 'Candidates': ['Q2990861', 'Q3071702', 'Q24088311', 'Q2355124', 'Q5669068', 'Q6552879', 'Q261583', 'Q336526', 'Q4895077', 'Q7174212', 'Q5807368', 'Q945511', 'Q4798810', 'Q298022', 'Q7736211', 'Q22097207', 'Q188', 'Q2699418', 'Q5364500', 'Q3708826', 'Q16729252', 'Q7922414', 'Q2734574', 'Q3735925', 'Q348514', 'Q7380995', 'Q7344737']}, {'Position': [28, 28], 'GroundTruth': 'Q145', 'Candidates': ['Q842438', 'Q1196012', 'Q1248800', 'Q849811']}, {'Position': [43, 43], 'GroundTruth': 'Q183', 'Candidates': ['Q41304', 'Q183', 'Q7318', 'Q22006587', 'Q1350565', 'Q423030', 'Q16209935']}, {'Position': [48, 49], 'GroundTruth': 'Q458', 'Candidates': ['Q319328', 'Q458']}, {'Position': [53, 54], 'GroundTruth': 'B', 'Candidates': []}, {'Position': [66, 66], 'GroundTruth': 'Q145', 'Candidates': ['Q16054730', 'Q3240725', 'Q690213']}, {'Position': [94, 94], 'GroundTruth': 'Q8880', 'Candidates': ['Q409597']}, {'Position': [98, 101], 'GroundTruth': 'B', 'Candidates': []}, {'Position': [129, 130], 'GroundTruth': 'Q458', 'Candidates': ['Q319328', 'Q458']}, {'Position': [139, 139], 'GroundTruth': 'B', 'Candidates': ['Q4053754', 'Q5413406', 'Q224475', 'Q5330551', 'Q458']}, {'Position': [142, 143], 'GroundTruth': 'Q78587', 'Candidates': ['Q78587']}, {'Position': [172, 172], 'GroundTruth': 'B', 'Candidates': ['Q2381525', 'Q1420333', 'Q2169476', 'Q78587', 'Q17180596', 'Q534915', 'Q3496482', 'Q686638']}, {'Position': [174, 174], 'GroundTruth': 'B', 'Candidates': []}, {'Position': [179, 179], 'GroundTruth': 'Q145', 'Candidates': ['Q16054730', 'Q3240725', 'Q690213']}, {'Position': [181, 181], 'GroundTruth': 'Q142', 'Candidates': ['Q5548178', 'Q726049', 'Q3037933', 'Q2556465', 'Q659488', 'Q16211444', 'Q732921', 'Q207162', 'Q5362797', 'Q504906', 'Q16275867', 'Q2149490', 'Q3080562', 'Q929852', 'Q142', 'Q6557993', 'Q5342978', 'Q49644', 'Q70802', 'Q6557995', 'Q70972', 'Q1083398', 'Q5478259', 'Q1658604', 'Q30123054', 'Q6408628', 'Q5525090', 'Q294485', 'Q3209212', 'Q42443', 'Q17351934']}, {'Position': [189, 191], 'GroundTruth': 'B', 'Candidates': []}, {'Position': [193, 193], 'GroundTruth': 'Q154666', 'Candidates': ['Q7449138', 'Q2636119', 'Q154666', 'Q638398', 'Q2380000', 'Q851259', 'Q4858621', 'Q1972649', 'Q262909', 'Q2480956', 'Q4081230']}, {'Position': [201, 201], 'GroundTruth': 'B', 'Candidates': ['Q2381525', 'Q1420333', 'Q2169476', 'Q78587', 'Q17180596', 'Q534915', 'Q3496482', 'Q686638']}, {'Position': [209, 209], 'GroundTruth': 'B', 'Candidates': ['Q4053754', 'Q5413406', 'Q224475', 'Q5330551', 'Q458']}, {'Position': [237, 237], 'GroundTruth': 'Q29', 'Candidates': ['Q241649', 'Q6267714', 'Q7573131', 'Q1321', 'Q3492565']}, {'Position': [240, 242], 'GroundTruth': 'Q255657', 'Candidates': ['Q255657']}, {'Position': [246, 246], 'GroundTruth': 'B', 'Candidates': ['Q2381525', 'Q1420333', 'Q2169476', 'Q78587', 'Q17180596', 'Q534915', 'Q3496482', 'Q686638']}, {'Position': [249, 249], 'GroundTruth': 'B', 'Candidates': ['Q4053754', 'Q5413406', 'Q224475', 'Q5330551', 'Q458']}, {'Position': [266, 266], 'GroundTruth': 'Q142', 'Candidates': ['Q5548178', 'Q726049', 'Q3037933', 'Q2556465', 'Q659488', 'Q16211444', 'Q732921', 'Q207162', 'Q5362797', 'Q504906', 'Q16275867', 'Q2149490', 'Q3080562', 'Q929852', 'Q142', 'Q6557993', 'Q5342978', 'Q49644', 'Q70802', 'Q6557995', 'Q70972', 'Q1083398', 'Q5478259', 'Q1658604', 'Q30123054', 'Q6408628', 'Q5525090', 'Q294485', 'Q3209212', 'Q42443', 'Q17351934']}, {'Position': [268, 268], 'GroundTruth': 'Q145', 'Candidates': ['Q16054730', 'Q3240725', 'Q690213']}, {'Position': [270, 270], 'GroundTruth': 'B', 'Candidates': ['Q2381525', 'Q1420333', 'Q2169476', 'Q78587', 'Q17180596', 'Q534915', 'Q3496482', 'Q686638']}, {'Position': [275, 275], 'GroundTruth': 'B', 'Candidates': ['Q4053754', 'Q5413406', 'Q224475', 'Q5330551', 'Q458']}, {'Position': [314, 314], 'GroundTruth': 'Q154666', 'Candidates': ['Q7449138', 'Q2636119', 'Q154666', 'Q638398', 'Q2380000', 'Q851259', 'Q4858621', 'Q1972649', 'Q262909', 'Q2480956', 'Q4081230']}, {'Position': [330, 330], 'GroundTruth': 'Q145', 'Candidates': ['Q842438', 'Q1196012', 'Q1248800', 'Q849811']}, {'Position': [350, 350], 'GroundTruth': 'Q183', 'Candidates': ['Q2990861', 'Q3071702', 'Q24088311', 'Q2355124', 'Q5669068', 'Q6552879', 'Q261583', 'Q336526', 'Q4895077', 'Q7174212', 'Q5807368', 'Q945511', 'Q4798810', 'Q298022', 'Q7736211', 'Q22097207', 'Q188', 'Q2699418', 'Q5364500', 'Q3708826', 'Q16729252', 'Q7922414', 'Q2734574', 'Q3735925', 'Q348514', 'Q7380995', 'Q7344737']}, {'Position': [357, 357], 'GroundTruth': 'Q145', 'Candidates': ['Q842438', 'Q1196012', 'Q1248800', 'Q849811']}, {'Position': [363, 363], 'GroundTruth': 'Q46', 'Candidates': ['Q345567', 'Q5412139', 'Q5412140', 'Q46', 'Q5412143', 'Q7815733', 'Q185144', 'Q579160', 'Q3734794', 'Q17065610', 'Q766618', 'Q198697', 'Q20706779', 'Q47462515', 'Q612228', 'Q165170', 'Q458']}, {'Position': [382, 382], 'GroundTruth': 'Q183', 'Candidates': ['Q41304', 'Q183', 'Q7318', 'Q22006587', 'Q1350565', 'Q423030', 'Q16209935']}, {'Position': [387, 391], 'GroundTruth': 'B', 'Candidates': []}, {'Position': [393, 393], 'GroundTruth': 'B', 'Candidates': ['Q564246', 'Q6972569', 'Q6972571']}, {'Position': [396, 398], 'GroundTruth': 'B', 'Candidates': []}, {'Position': [401, 402], 'GroundTruth': 'B', 'Candidates': []}, {'Position': [404, 404], 'GroundTruth': 'Q586', 'Candidates': ['Q892680', 'Q586', 'Q24203375']}, {'Position': [420, 420], 'GroundTruth': 'Q145', 'Candidates': ['Q842438', 'Q1196012', 'Q1248800', 'Q849811']}, {'Position': [438, 438], 'GroundTruth': 'Q183', 'Candidates': ['Q41304', 'Q183', 'Q7318', 'Q22006587', 'Q1350565', 'Q423030', 'Q16209935']}, {'Position': [443, 443], 'GroundTruth': 'Q145', 'Candidates': ['Q16054730', 'Q3240725', 'Q690213']}, {'Position': [459, 459], 'GroundTruth': 'Q145', 'Candidates': ['Q842438', 'Q1196012', 'Q1248800', 'Q849811']}]
        result = self.subject.generate_candidates_for_doc(doc)
        err_msg = "Generating candidates for first doc didn't give expected results."
        self.assertEqual(expected, result, err_msg)


if __name__ == '__main__':
    unittest.main()
